"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.CcApiContextProviderPlugin = void 0;
const sdk_provider_1 = require("../api/aws-auth/sdk-provider");
const error_1 = require("../toolkit/error");
const json_1 = require("../util/json");
class CcApiContextProviderPlugin {
    constructor(aws) {
        this.aws = aws;
    }
    /**
     * This returns a data object with the value from CloudControl API result.
     * args.typeName - see https://docs.aws.amazon.com/cloudcontrolapi/latest/userguide/supported-resources.html
     * args.exactIdentifier -  use CC API getResource.
     * args.propertyMatch - use CCP API listResources to get resources and propertyMatch to search through the list.
     * args.propertiesToReturn - Properties from CC API to return.
     */
    async getValue(args) {
        const cloudControl = (await (0, sdk_provider_1.initContextProviderSdk)(this.aws, args)).cloudControl();
        const result = await this.findResources(cloudControl, args);
        return result;
    }
    async findResources(cc, args) {
        if (args.exactIdentifier && args.propertyMatch) {
            throw new error_1.ContextProviderError(`Specify either exactIdentifier or propertyMatch, but not both. Failed to find resources using CC API for type ${args.typeName}.`);
        }
        if (!args.exactIdentifier && !args.propertyMatch) {
            throw new error_1.ContextProviderError(`Neither exactIdentifier nor propertyMatch is specified. Failed to find resources using CC API for type ${args.typeName}.`);
        }
        if (args.exactIdentifier) {
            // use getResource to get the exact indentifier
            return this.getResource(cc, args.typeName, args.exactIdentifier, args.propertiesToReturn);
        }
        else {
            // use listResource
            return this.listResources(cc, args.typeName, args.propertyMatch, args.propertiesToReturn);
        }
    }
    /**
     * Calls getResource from CC API to get the resource.
     * See https://docs.aws.amazon.com/cli/latest/reference/cloudcontrol/get-resource.html
     *
     * If the exactIdentifier is not found, then an empty map is returned.
     * If the resource is found, then a map of the identifier to a map of property values is returned.
     */
    async getResource(cc, typeName, exactIdentifier, propertiesToReturn) {
        var _a, _b, _c, _d, _e;
        const resultObjs = [];
        try {
            const result = await cc.getResource({
                TypeName: typeName,
                Identifier: exactIdentifier,
            });
            const id = (_b = (_a = result.ResourceDescription) === null || _a === void 0 ? void 0 : _a.Identifier) !== null && _b !== void 0 ? _b : '';
            if (id !== '') {
                const propsObject = JSON.parse((_d = (_c = result.ResourceDescription) === null || _c === void 0 ? void 0 : _c.Properties) !== null && _d !== void 0 ? _d : '');
                const propsObj = (0, json_1.getResultObj)(propsObject, (_e = result.ResourceDescription) === null || _e === void 0 ? void 0 : _e.Identifier, propertiesToReturn);
                resultObjs.push(propsObj);
            }
            else {
                throw new error_1.ContextProviderError(`Could not get resource ${exactIdentifier}.`);
            }
        }
        catch (err) {
            throw new error_1.ContextProviderError(`Encountered CC API error while getting resource ${exactIdentifier}. Error: ${err}`);
        }
        return resultObjs;
    }
    /**
     * Calls listResources from CC API to get the resources and apply args.propertyMatch to find the resources.
     * See https://docs.aws.amazon.com/cli/latest/reference/cloudcontrol/list-resources.html
     *
     * Since exactIdentifier is not specified, propertyMatch must be specified.
     * This returns an object where the ids are object keys and values are objects with keys of args.propertiesToReturn.
     */
    async listResources(cc, typeName, propertyMatch, propertiesToReturn) {
        var _a;
        const resultObjs = [];
        try {
            const result = await cc.listResources({
                TypeName: typeName,
            });
            (_a = result.ResourceDescriptions) === null || _a === void 0 ? void 0 : _a.forEach((resource) => {
                var _a, _b;
                const id = (_a = resource.Identifier) !== null && _a !== void 0 ? _a : '';
                if (id !== '') {
                    const propsObject = JSON.parse((_b = resource.Properties) !== null && _b !== void 0 ? _b : '');
                    const filters = Object.entries(propertyMatch);
                    let match = false;
                    if (filters) {
                        match = filters.every((record, _index, _arr) => {
                            const key = record[0];
                            const expected = record[1];
                            const actual = (0, json_1.findJsonValue)(propsObject, key);
                            return propertyMatchesFilter(actual, expected);
                        });
                        function propertyMatchesFilter(actual, expected) {
                            // For now we just check for strict equality, but we can implement pattern matching and fuzzy matching here later
                            return expected === actual;
                        }
                    }
                    if (match) {
                        const propsObj = (0, json_1.getResultObj)(propsObject, resource.Identifier, propertiesToReturn);
                        resultObjs.push(propsObj);
                    }
                }
            });
        }
        catch (err) {
            throw new error_1.ContextProviderError(`Could not get resources ${JSON.stringify(propertyMatch)}. Error: ${err}`);
        }
        return resultObjs;
    }
}
exports.CcApiContextProviderPlugin = CcApiContextProviderPlugin;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2MtYXBpLXByb3ZpZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY2MtYXBpLXByb3ZpZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUVBLCtEQUF3RjtBQUV4Riw0Q0FBd0Q7QUFDeEQsdUNBQTJEO0FBRTNELE1BQWEsMEJBQTBCO0lBQ3JDLFlBQTZCLEdBQWdCO1FBQWhCLFFBQUcsR0FBSCxHQUFHLENBQWE7SUFDN0MsQ0FBQztJQUVEOzs7Ozs7T0FNRztJQUNJLEtBQUssQ0FBQyxRQUFRLENBQUMsSUFBdUI7UUFDM0MsTUFBTSxZQUFZLEdBQUcsQ0FBQyxNQUFNLElBQUEscUNBQXNCLEVBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLFlBQVksRUFBRSxDQUFDO1FBRW5GLE1BQU0sTUFBTSxHQUFHLE1BQU0sSUFBSSxDQUFDLGFBQWEsQ0FBQyxZQUFZLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDNUQsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQztJQUVPLEtBQUssQ0FBQyxhQUFhLENBQUMsRUFBdUIsRUFBRSxJQUF1QjtRQUMxRSxJQUFJLElBQUksQ0FBQyxlQUFlLElBQUksSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1lBQy9DLE1BQU0sSUFBSSw0QkFBb0IsQ0FBQyxpSEFBaUgsSUFBSSxDQUFDLFFBQVEsR0FBRyxDQUFDLENBQUM7UUFDcEssQ0FBQztRQUNELElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1lBQ2pELE1BQU0sSUFBSSw0QkFBb0IsQ0FBQywwR0FBMEcsSUFBSSxDQUFDLFFBQVEsR0FBRyxDQUFDLENBQUM7UUFDN0osQ0FBQztRQUVELElBQUksSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO1lBQ3pCLCtDQUErQztZQUMvQyxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxRQUFRLEVB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QUFBLG9CQUFhLEVBQUMsV0FBVyxFQUFFLEdBQUcsQ0FBQyxDQUFDOzRCQUMvQyxPQUFPLHFCQUFxQixDQUFDLE1BQU0sRUFBRSxRQUFRLENBQUMsQ0FBQzt3QkFDakQsQ0FBQyxDQUFDLENBQUM7d0JBRUgsU0FBUyxxQkFBcUIsQ0FBQyxNQUFXLEVBQUUsUUFBaUI7NEJBQzNELGlIQUFpSDs0QkFDakgsT0FBTyxRQUFRLEtBQUssTUFBTSxDQUFDO3dCQUM3QixDQUFDO29CQUNILENBQUM7b0JBRUQsSUFBSSxLQUFLLEVBQUUsQ0FBQzt3QkFDVixNQUFNLFFBQVEsR0FBRyxJQUFBLG1CQUFZLEVBQUMsV0FBVyxFQUFFLFFBQVEsQ0FBQyxVQUFXLEVBQUUsa0JBQWtCLENBQUMsQ0FBQzt3QkFDckYsVUFBVSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztvQkFDNUIsQ0FBQztnQkFDSCxDQUFDO1lBQ0gsQ0FBQyxDQUFDLENBQUM7UUFDTCxDQUFDO1FBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztZQUNiLE1BQU0sSUFBSSw0QkFBb0IsQ0FBQywyQkFBMkIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUMsWUFBWSxHQUFHLEVBQUUsQ0FBQyxDQUFDO1FBQzVHLENBQUM7UUFDRCxPQUFPLFVBQVUsQ0FBQztJQUNwQixDQUFDO0NBQ0Y7QUF2SEQsZ0VBdUhDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUgeyBDY0FwaUNvbnRleHRRdWVyeSB9IGZyb20gJ0Bhd3MtY2RrL2Nsb3VkLWFzc2VtYmx5LXNjaGVtYSc7XG5pbXBvcnQgeyBJQ2xvdWRDb250cm9sQ2xpZW50IH0gZnJvbSAnLi4vYXBpJztcbmltcG9ydCB7IHR5cGUgU2RrUHJvdmlkZXIsIGluaXRDb250ZXh0UHJvdmlkZXJTZGsgfSBmcm9tICcuLi9hcGkvYXdzLWF1dGgvc2RrLXByb3ZpZGVyJztcbmltcG9ydCB7IENvbnRleHRQcm92aWRlclBsdWdpbiB9IGZyb20gJy4uL2FwaS9wbHVnaW4nO1xuaW1wb3J0IHsgQ29udGV4dFByb3ZpZGVyRXJyb3IgfSBmcm9tICcuLi90b29sa2l0L2Vycm9yJztcbmltcG9ydCB7IGZpbmRKc29uVmFsdWUsIGdldFJlc3VsdE9iaiB9IGZyb20gJy4uL3V0aWwvanNvbic7XG5cbmV4cG9ydCBjbGFzcyBDY0FwaUNvbnRleHRQcm92aWRlclBsdWdpbiBpbXBsZW1lbnRzIENvbnRleHRQcm92aWRlclBsdWdpbiB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgYXdzOiBTZGtQcm92aWRlcikge1xuICB9XG5cbiAgLyoqXG4gICAqIFRoaXMgcmV0dXJucyBhIGRhdGEgb2JqZWN0IHdpdGggdGhlIHZhbHVlIGZyb20gQ2xvdWRDb250cm9sIEFQSSByZXN1bHQuXG4gICAqIGFyZ3MudHlwZU5hbWUgLSBzZWUgaHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL2Nsb3VkY29udHJvbGFwaS9sYXRlc3QvdXNlcmd1aWRlL3N1cHBvcnRlZC1yZXNvdXJjZXMuaHRtbFxuICAgKiBhcmdzLmV4YWN0SWRlbnRpZmllciAtICB1c2UgQ0MgQVBJIGdldFJlc291cmNlLlxuICAgKiBhcmdzLnByb3BlcnR5TWF0Y2ggLSB1c2UgQ0NQIEFQSSBsaXN0UmVzb3VyY2VzIHRvIGdldCByZXNvdXJjZXMgYW5kIHByb3BlcnR5TWF0Y2ggdG8gc2VhcmNoIHRocm91Z2ggdGhlIGxpc3QuXG4gICAqIGFyZ3MucHJvcGVydGllc1RvUmV0dXJuIC0gUHJvcGVydGllcyBmcm9tIENDIEFQSSB0byByZXR1cm4uXG4gICAqL1xuICBwdWJsaWMgYXN5bmMgZ2V0VmFsdWUoYXJnczogQ2NBcGlDb250ZXh0UXVlcnkpIHtcbiAgICBjb25zdCBjbG91ZENvbnRyb2wgPSAoYXdhaXQgaW5pdENvbnRleHRQcm92aWRlclNkayh0aGlzLmF3cywgYXJncykpLmNsb3VkQ29udHJvbCgpO1xuXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5maW5kUmVzb3VyY2VzKGNsb3VkQ29udHJvbCwgYXJncyk7XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZmluZFJlc291cmNlcyhjYzogSUNsb3VkQ29udHJvbENsaWVudCwgYXJnczogQ2NBcGlDb250ZXh0UXVlcnkpOiBQcm9taXNlPHtba2V5OiBzdHJpbmddOiBhbnl9IFtdPiB7XG4gICAgaWYgKGFyZ3MuZXhhY3RJZGVudGlmaWVyICYmIGFyZ3MucHJvcGVydHlNYXRjaCkge1xuICAgICAgdGhyb3cgbmV3IENvbnRleHRQcm92aWRlckVycm9yKGBTcGVjaWZ5IGVpdGhlciBleGFjdElkZW50aWZpZXIgb3IgcHJvcGVydHlNYXRjaCwgYnV0IG5vdCBib3RoLiBGYWlsZWQgdG8gZmluZCByZXNvdXJjZXMgdXNpbmcgQ0MgQVBJIGZvciB0eXBlICR7YXJncy50eXBlTmFtZX0uYCk7XG4gICAgfVxuICAgIGlmICghYXJncy5leGFjdElkZW50aWZpZXIgJiYgIWFyZ3MucHJvcGVydHlNYXRjaCkge1xuICAgICAgdGhyb3cgbmV3IENvbnRleHRQcm92aWRlckVycm9yKGBOZWl0aGVyIGV4YWN0SWRlbnRpZmllciBub3IgcHJvcGVydHlNYXRjaCBpcyBzcGVjaWZpZWQuIEZhaWxlZCB0byBmaW5kIHJlc291cmNlcyB1c2luZyBDQyBBUEkgZm9yIHR5cGUgJHthcmdzLnR5cGVOYW1lfS5gKTtcbiAgICB9XG5cbiAgICBpZiAoYXJncy5leGFjdElkZW50aWZpZXIpIHtcbiAgICAgIC8vIHVzZSBnZXRSZXNvdXJjZSB0byBnZXQgdGhlIGV4YWN0IGluZGVudGlmaWVyXG4gICAgICByZXR1cm4gdGhpcy5nZXRSZXNvdXJjZShjYywgYXJncy50eXBlTmFtZSwgYXJncy5leGFjdElkZW50aWZpZXIsIGFyZ3MucHJvcGVydGllc1RvUmV0dXJuKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gdXNlIGxpc3RSZXNvdXJjZVxuICAgICAgcmV0dXJuIHRoaXMubGlzdFJlc291cmNlcyhjYywgYXJncy50eXBlTmFtZSwgYXJncy5wcm9wZXJ0eU1hdGNoISwgYXJncy5wcm9wZXJ0aWVzVG9SZXR1cm4pO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBDYWxscyBnZXRSZXNvdXJjZSBmcm9tIENDIEFQSSB0byBnZXQgdGhlIHJlc291cmNlLlxuICAgKiBTZWUgaHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL2NsaS9sYXRlc3QvcmVmZXJlbmNlL2Nsb3VkY29udHJvbC9nZXQtcmVzb3VyY2UuaHRtbFxuICAgKlxuICAgKiBJZiB0aGUgZXhhY3RJZGVudGlmaWVyIGlzIG5vdCBmb3VuZCwgdGhlbiBhbiBlbXB0eSBtYXAgaXMgcmV0dXJuZWQuXG4gICAqIElmIHRoZSByZXNvdXJjZSBpcyBmb3VuZCwgdGhlbiBhIG1hcCBvZiB0aGUgaWRlbnRpZmllciB0byBhIG1hcCBvZiBwcm9wZXJ0eSB2YWx1ZXMgaXMgcmV0dXJuZWQuXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIGdldFJlc291cmNlKFxuICAgIGNjOiBJQ2xvdWRDb250cm9sQ2xpZW50LFxuICAgIHR5cGVOYW1lOiBzdHJpbmcsXG4gICAgZXhhY3RJZGVudGlmaWVyOiBzdHJpbmcsXG4gICAgcHJvcGVydGllc1RvUmV0dXJuOiBzdHJpbmdbXSxcbiAgKTogUHJvbWlzZTx7W2tleTogc3RyaW5nXTogYW55fVtdPiB7XG4gICAgY29uc3QgcmVzdWx0T2Jqczoge1trZXk6IHN0cmluZ106IGFueX1bXSA9IFtdO1xuICAgIHRyeSB7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBjYy5nZXRSZXNvdXJjZSh7XG4gICAgICAgIFR5cGVOYW1lOiB0eXBlTmFtZSxcbiAgICAgICAgSWRlbnRpZmllcjogZXhhY3RJZGVudGlmaWVyLFxuICAgICAgfSk7XG4gICAgICBjb25zdCBpZCA9IHJlc3VsdC5SZXNvdXJjZURlc2NyaXB0aW9uPy5JZGVudGlmaWVyID8/ICcnO1xuICAgICAgaWYgKGlkICE9PSAnJykge1xuICAgICAgICBjb25zdCBwcm9wc09iamVjdCA9IEpTT04ucGFyc2UocmVzdWx0LlJlc291cmNlRGVzY3JpcHRpb24/LlByb3BlcnRpZXMgPz8gJycpO1xuICAgICAgICBjb25zdCBwcm9wc09iaiA9IGdldFJlc3VsdE9iaihwcm9wc09iamVjdCwgcmVzdWx0LlJlc291cmNlRGVzY3JpcHRpb24/LklkZW50aWZpZXIhLCBwcm9wZXJ0aWVzVG9SZXR1cm4pO1xuICAgICAgICByZXN1bHRPYmpzLnB1c2gocHJvcHNPYmopO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgbmV3IENvbnRleHRQcm92aWRlckVycm9yKGBDb3VsZCBub3QgZ2V0IHJlc291cmNlICR7ZXhhY3RJZGVudGlmaWVyfS5gKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIHRocm93IG5ldyBDb250ZXh0UHJvdmlkZXJFcnJvcihgRW5jb3VudGVyZWQgQ0MgQVBJIGVycm9yIHdoaWxlIGdldHRpbmcgcmVzb3VyY2UgJHtleGFjdElkZW50aWZpZXJ9LiBFcnJvcjogJHtlcnJ9YCk7XG4gICAgfVxuICAgIHJldHVybiByZXN1bHRPYmpzO1xuICB9XG5cbiAgLyoqXG4gICAqIENhbGxzIGxpc3RSZXNvdXJjZXMgZnJvbSBDQyBBUEkgdG8gZ2V0IHRoZSByZXNvdXJjZXMgYW5kIGFwcGx5IGFyZ3MucHJvcGVydHlNYXRjaCB0byBmaW5kIHRoZSByZXNvdXJjZXMuXG4gICAqIFNlZSBodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vY2xpL2xhdGVzdC9yZWZlcmVuY2UvY2xvdWRjb250cm9sL2xpc3QtcmVzb3VyY2VzLmh0bWxcbiAgICpcbiAgICogU2luY2UgZXhhY3RJZGVudGlmaWVyIGlzIG5vdCBzcGVjaWZpZWQsIHByb3BlcnR5TWF0Y2ggbXVzdCBiZSBzcGVjaWZpZWQuXG4gICAqIFRoaXMgcmV0dXJucyBhbiBvYmplY3Qgd2hlcmUgdGhlIGlkcyBhcmUgb2JqZWN0IGtleXMgYW5kIHZhbHVlcyBhcmUgb2JqZWN0cyB3aXRoIGtleXMgb2YgYXJncy5wcm9wZXJ0aWVzVG9SZXR1cm4uXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIGxpc3RSZXNvdXJjZXMoXG4gICAgY2M6IElDbG91ZENvbnRyb2xDbGllbnQsXG4gICAgdHlwZU5hbWU6IHN0cmluZyxcbiAgICBwcm9wZXJ0eU1hdGNoOiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPixcbiAgICBwcm9wZXJ0aWVzVG9SZXR1cm46IHN0cmluZ1tdLFxuICApOiBQcm9taXNlPHtba2V5OiBzdHJpbmddOiBhbnl9W10+IHtcbiAgICBjb25zdCByZXN1bHRPYmpzOiB7W2tleTogc3RyaW5nXTogYW55fVtdID0gW107XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgY2MubGlzdFJlc291cmNlcyh7XG4gICAgICAgIFR5cGVOYW1lOiB0eXBlTmFtZSxcbiAgICAgIH0pO1xuICAgICAgcmVzdWx0LlJlc291cmNlRGVzY3JpcHRpb25zPy5mb3JFYWNoKChyZXNvdXJjZSkgPT4ge1xuICAgICAgICBjb25zdCBpZCA9IHJlc291cmNlLklkZW50aWZpZXIgPz8gJyc7XG4gICAgICAgIGlmIChpZCAhPT0gJycpIHtcbiAgICAgICAgICBjb25zdCBwcm9wc09iamVjdCA9IEpTT04ucGFyc2UocmVzb3VyY2UuUHJvcGVydGllcyA/PyAnJyk7XG5cbiAgICAgICAgICBjb25zdCBmaWx0ZXJzID0gT2JqZWN0LmVudHJpZXMocHJvcGVydHlNYXRjaCk7XG4gICAgICAgICAgbGV0IG1hdGNoID0gZmFsc2U7XG4gICAgICAgICAgaWYgKGZpbHRlcnMpIHtcbiAgICAgICAgICAgIG1hdGNoID0gZmlsdGVycy5ldmVyeSgocmVjb3JkLCBfaW5kZXgsIF9hcnIpID0+IHtcbiAgICAgICAgICAgICAgY29uc3Qga2V5ID0gcmVjb3JkWzBdO1xuICAgICAgICAgICAgICBjb25zdCBleHBlY3RlZCA9IHJlY29yZFsxXTtcbiAgICAgICAgICAgICAgY29uc3QgYWN0dWFsID0gZmluZEpzb25WYWx1ZShwcm9wc09iamVjdCwga2V5KTtcbiAgICAgICAgICAgICAgcmV0dXJuIHByb3BlcnR5TWF0Y2hlc0ZpbHRlcihhY3R1YWwsIGV4cGVjdGVkKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBmdW5jdGlvbiBwcm9wZXJ0eU1hdGNoZXNGaWx0ZXIoYWN0dWFsOiBhbnksIGV4cGVjdGVkOiB1bmtub3duKSB7XG4gICAgICAgICAgICAgIC8vIEZvciBub3cgd2UganVzdCBjaGVjayBmb3Igc3RyaWN0IGVxdWFsaXR5LCBidXQgd2UgY2FuIGltcGxlbWVudCBwYXR0ZXJuIG1hdGNoaW5nIGFuZCBmdXp6eSBtYXRjaGluZyBoZXJlIGxhdGVyXG4gICAgICAgICAgICAgIHJldHVybiBleHBlY3RlZCA9PT0gYWN0dWFsO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cblxuICAgICAgICAgIGlmIChtYXRjaCkge1xuICAgICAgICAgICAgY29uc3QgcHJvcHNPYmogPSBnZXRSZXN1bHRPYmoocHJvcHNPYmplY3QsIHJlc291cmNlLklkZW50aWZpZXIhLCBwcm9wZXJ0aWVzVG9SZXR1cm4pO1xuICAgICAgICAgICAgcmVzdWx0T2Jqcy5wdXNoKHByb3BzT2JqKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgdGhyb3cgbmV3IENvbnRleHRQcm92aWRlckVycm9yKGBDb3VsZCBub3QgZ2V0IHJlc291cmNlcyAke0pTT04uc3RyaW5naWZ5KHByb3BlcnR5TWF0Y2gpfS4gRXJyb3I6ICR7ZXJyfWApO1xuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0T2JqcztcbiAgfVxufVxuIl19